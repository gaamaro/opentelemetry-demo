.PHONY: deploy-all deploy check-health

deploy:
	@echo "üöÄ Iniciando deploy na EC2 remota..."
	@ssh ec2 'cd /repo/opentelemetry-demo && \
		export $$(cat dynatrace.env | xargs) && \
		docker compose pull && \
		docker compose up --force-recreate --remove-orphans --detach'

check-health:
	@echo "üîç Verificando sa√∫de dos containers na EC2..."
	@echo "‚è≥ Aguardando inicializa√ß√£o dos containers..."
	@for i in $$(seq 1 6); do \
		echo "Tentativa $$i de 6..."; \
		sleep 10; \
		CONTAINERS_UP=$$(ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "up" | wc -l'); \
		CONTAINERS_TOTAL=$$(ssh ec2 'docker ps --format "{{.Names}}" | wc -l'); \
		if [ "$$CONTAINERS_UP" = "$$CONTAINERS_TOTAL" ]; then \
			echo "‚úÖ Todos os containers est√£o em execu√ß√£o!"; \
			break; \
		fi; \
		if [ "$$i" = "6" ]; then \
			echo "‚ùå Timeout: Nem todos os containers iniciaram ap√≥s 60 segundos"; \
			ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}"'; \
			exit 1; \
		fi; \
	done
	@echo "üîç Verificando status de sa√∫de..."
	@UNHEALTHY=$$(ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy" | wc -l'); \
	if [ "$$UNHEALTHY" -gt 0 ]; then \
		echo "‚ö†Ô∏è Containers unhealthy encontrados:"; \
		ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy"'; \
		exit 1; \
	else \
		echo "‚úÖ Todos os containers est√£o saud√°veis!"; \
	fi

deploy-all: deploy check-health
	@echo "‚ú® Deploy finalizado com sucesso!" 