.PHONY: deploy-all deploy check-health

deploy:
	@echo "üöÄ Iniciando deploy na EC2 remota..."
	@ssh ec2 'cd /repo/opentelemetry-demo && \
		export $$(cat dynatrace.env | xargs) && \
		docker compose pull && \
		docker compose up --force-recreate --remove-orphans --detach'

check-health:
	@echo "üîç Verificando sa√∫de dos containers na EC2..."
	@sleep 30  # Aguarda 30 segundos para os containers inicializarem
	@ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "up"' || (echo "‚ùå Nenhum container em execu√ß√£o!" && exit 1)
	@ssh ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy"' && echo "‚ö†Ô∏è Containers unhealthy encontrados!" || echo "‚úÖ Todos os containers est√£o saud√°veis"

deploy-all: deploy check-health
	@echo "‚ú® Deploy finalizado com sucesso!" 