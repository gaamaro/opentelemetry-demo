name: Deploy to EC2

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      reason:
        description: 'Motivo do deploy manual'
        required: true
        type: string

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install make
        run: |
          sudo apt-get update && sudo apt-get install make

      - name: Get Secrets from Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          # Testar conex√£o com Vault
          echo "üîç Testando conex√£o com Vault..."
          curl -s -k ${VAULT_ADDR}/v1/sys/health || (echo "‚ùå N√£o foi poss√≠vel conectar ao Vault" && exit 1)
          
          echo "üì¶ Obtendo secrets do Vault..."
          # Obter IP da EC2
          RAW_IP=$(curl -s -k -H "X-Vault-Token: ${VAULT_TOKEN}" ${VAULT_ADDR}/v1/kv/data/ec2-ip | jq -r '.data.data.ip')
          EC2_IP=$(echo "$RAW_IP" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          
          # Validar IP
          if [[ ! $EC2_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå IP inv√°lido encontrado: $EC2_IP"
            exit 1
          fi
          echo "‚úÖ IP da EC2 encontrado: $EC2_IP"
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
          
          # Obter chave SSH
          echo "üîë Obtendo chave SSH do Vault..."
          curl -s -k -H "X-Vault-Token: ${VAULT_TOKEN}" ${VAULT_ADDR}/v1/kv/data/ssh-default | jq -r '.data.data.private_key' > private_key.pem
          chmod 600 private_key.pem
          echo "PRIVATE_KEY_PATH=$PWD/private_key.pem" >> $GITHUB_ENV
          
          # Obter credenciais Dynatrace
          DT_ENDPOINT=$(curl -s -k -H "X-Vault-Token: ${VAULT_TOKEN}" ${VAULT_ADDR}/v1/kv/data/dynatrace | jq -r '.data.data.env')
          DT_API_TOKEN=$(curl -s -k -H "X-Vault-Token: ${VAULT_TOKEN}" ${VAULT_ADDR}/v1/kv/data/dynatrace | jq -r '.data.data.otel_token')
          
          # Criar arquivo de vari√°veis do Dynatrace
          echo "DT_ENDPOINT=$DT_ENDPOINT" > dynatrace.env
          echo "DT_API_TOKEN=$DT_API_TOKEN" >> dynatrace.env

      - name: Setup and Test SSH Connection
        run: |
          echo "üîç Verificando chave SSH..."
          ls -la ${{ env.PRIVATE_KEY_PATH }}
          echo "Primeiras linhas da chave:"
          head -n 2 ${{ env.PRIVATE_KEY_PATH }}
          
          echo "üîß Configurando SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "Host ec2
            HostName ${{ env.EC2_IP }}
            User ec2-user
            IdentityFile ${{ env.PRIVATE_KEY_PATH }}
            StrictHostKeyChecking no" > ~/.ssh/config
          
          echo "üìÑ Configura√ß√£o SSH:"
          cat ~/.ssh/config
          
          echo "üîå Testando conex√£o SSH com debug..."
          ssh -vvv ec2 'echo "Conex√£o SSH bem sucedida!"' || (echo "‚ùå Erro na conex√£o SSH" && exit 1)

      - name: Copy Dynatrace Config
        run: |
          scp dynatrace.env ec2:/repo/opentelemetry-demo/
          echo "‚úÖ Arquivo de vari√°veis copiado para EC2"

      - name: Deploy to EC2
        run: |
          cd startup
          make deploy-all

      - name: Log Deploy Info
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Deploy manual executado"
          echo "Ambiente: ${{ github.event.inputs.environment }}"
          echo "Motivo: ${{ github.event.inputs.reason }}" 